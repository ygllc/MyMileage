# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL Advanced"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '45 1 * * 6'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Runner selection; use macOS only for swift
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    env:
      # Change this if your project needs a different JDK (e.g., "17")
      JAVA_VERSION: '17'

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: java-kotlin
          build-mode: manual
        # Supported languages: actions, c-cpp, csharp, go, java-kotlin, javascript-typescript, python, ruby, rust, swift

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        # Add custom queries here if required:
        # queries: security-extended,security-and-quality

    # Manual build: set up JDK (only for manual build-mode)
    - name: Set up JDK
      if: matrix.build-mode == 'manual'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    # Cache Gradle artifacts (helps speed up builds)
    - name: Cache Gradle
      if: matrix.build-mode == 'manual'
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-cache-${{ runner.os }}-

    # Cache Maven repository (fallback when using Maven)
    - name: Cache Maven local repository
      if: matrix.build-mode == 'manual'
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: maven-cache-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          maven-cache-${{ runner.os }}-

    # Run manual build steps (Gradle wrapper preferred, fallback to Maven)
    - name: Run manual build steps
      if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo "Starting manual build for java-kotlin"

        # Prefer Gradle wrapper if present
        if [ -x "./gradlew" ] || [ -f "./gradlew" ]; then
          echo "Detected Gradle wrapper (gradlew). Running Gradle build..."
          chmod +x ./gradlew || true

          # If this is an Android project, assembleDebug (produces bytecode).
          if grep -q "com.android" build.gradle* 2>/dev/null || grep -q "com.android" settings.gradle* 2>/dev/null; then
            echo "Android project detected. Running: ./gradlew assembleDebug --no-daemon --stacktrace"
            ./gradlew assembleDebug --no-daemon --stacktrace
          else
            echo "Running: ./gradlew build --no-daemon --stacktrace"
            ./gradlew build --no-daemon --stacktrace
          fi

        # Fallback to Maven if no Gradle wrapper
        elif [ -f "pom.xml" ]; then
          if command -v mvn >/dev/null 2>&1; then
            echo "Detected Maven project. Running: mvn -B -DskipTests package"
            mvn -B -DskipTests package
          else
            echo "Maven build file found (pom.xml) but mvn is not available in the runner."
            exit 1
          fi

        else
          echo "No supported build system detected (no ./gradlew and no pom.xml)."
          echo "Please update .github/workflows/codeql.yml to run the correct build commands for your project."
          exit 1
        fi

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"
